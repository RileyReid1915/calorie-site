<div id="calorie-widget" style="width: 100%; max-width: 600px; margin: 20px auto;">
  <h2>Калькулятор Калорій</h2>
  <form id="calorie-form">
    <label for="weight-slider">Вага (кг): <span id="weight-value">30</span></label>
    <input type="range" id="weight-slider" min="30" max="200" value="30">

    <label for="height-slider">Зріст (см): <span id="height-value">100</span></label>
    <input type="range" id="height-slider" min="100" max="220" value="100">

    <label for="age-slider">Вік: <span id="age-value">18</span></label>
    <input type="range" id="age-slider" min="18" max="65" value="18">

    <select id="gender">
      <option value="male">Чоловік</option>
      <option value="female">Жінка</option>
    </select>
    <button type="submit">Розрахувати</button>
  </form>

  <p id="result"></p>
  <div id="3d-container" style="width: 100%; height: 300px; margin-top: 20px;"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    (function() {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, 600 / 300, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(600, 300);
      document.getElementById('3d-container').appendChild(renderer.domElement);

      let model;

      const light = new THREE.AmbientLight(0xffffff, 1);
      scene.add(light);

      const loader = new THREE.GLTFLoader();
      loader.load(
        'https://raw.githubusercontent.com/RileyReid1915/3d-models/main/human.glb',
        (gltf) => {
          model = gltf.scene;
          console.log('Модель завантажена:', model);

          model.scale.set(2, 2, 2);

          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          model.position.sub(center);

          scene.add(model);

          const size = box.getSize(new THREE.Vector3());
          camera.position.z = Math.max(size.x, size.y, size.z) * 0.34;
          camera.lookAt(0, 0, 0);

          animate();
        },
        undefined,
        (error) => console.error('Помилка завантаження моделі:', error)
      );

      function animate() {
        requestAnimationFrame(animate);
        if (model) model.rotation.y += 0.01;
        renderer.render(scene, camera);
      }

      function updateShapeKeys() {
        if (!model) return;

        const mesh = model.children[0];
        console.log('Перевірка mesh:', mesh);

        if (mesh.morphTargetDictionary && mesh.morphTargetInfluences) {
          console.log('morphTargetDictionary:', mesh.morphTargetDictionary);

          const key1Index = mesh.morphTargetDictionary['key1'];
          const key2Index = mesh.morphTargetDictionary['key2'];
          const key3Index = mesh.morphTargetDictionary['key3'];

          if (key1Index !== undefined) {
            mesh.morphTargetInfluences[key1Index] = (document.getElementById('height-slider').value - 100) / 120;
          }
          if (key2Index !== undefined) {
            mesh.morphTargetInfluences[key2Index] = (document.getElementById('weight-slider').value - 30) / 170;
          }
          if (key3Index !== undefined) {
            mesh.morphTargetInfluences[key3Index] = (document.getElementById('age-slider').value - 18) / 47;
          }
        } else {
          console.warn('Модель не містить shape keys.');
        }
      }

      document.querySelectorAll('input[type="range"]').forEach(slider => {
        slider.addEventListener('input', (e) => {
          const valueSpan = document.getElementById(`${e.target.id.split('-')[0]}-value`);
          valueSpan.textContent = e.target.value;
          updateShapeKeys();
        });
      });

      document.getElementById('calorie-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const weight = parseFloat(document.getElementById('weight-slider').value);
        const height = parseFloat(document.getElementById('height-slider').value);
        const age = parseInt(document.getElementById('age-slider').value);
        const gender = document.getElementById('gender').value;

        try {
          const response = await fetch('https://calorie-api-n8u8.onrender.com/api/calculate-calories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weight, height, age, gender })
          });

          if (!response.ok) throw new Error('Помилка при запиті до API');

          const data = await response.json();
          document.getElementById('result').innerText = `Добова норма калорій: ${data.daily_calories} ккал`;

          updateShapeKeys();
        } catch (error) {
          document.getElementById('result').innerText = 'Сталася помилка: ' + error.message;
        }
      });
    })();
  </script>
</div>
