<div id="calorie-widget" style="width: 100%; max-width: 600px; margin: 20px auto;">
  <h2>Калькулятор Калорій</h2>
  <form id="calorie-form">
    <input type="number" id="weight" placeholder="Вага (кг)" required>
    <input type="number" id="height" placeholder="Зріст (см)" required>
    <input type="number" id="age" placeholder="Вік" required>
    <select id="gender">
      <option value="male">Чоловік</option>
      <option value="female">Жінка</option>
    </select>
    <button type="submit">Розрахувати</button>
  </form>

  <p id="result"></p>
  <div id="3d-container" style="width: 100%; height: 300px; margin-top: 20px;"></div>

  <!-- Підключення Three.js та GLTFLoader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>

    <script>
    (function() {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, 600 / 300, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(600, 300);
      document.getElementById('3d-container').appendChild(renderer.domElement);

      let model;

      // Додаємо базове освітлення
      const light = new THREE.AmbientLight(0xffffff, 1); // Біле світло
      scene.add(light);

      // Завантаження моделі
      const loader = new THREE.GLTFLoader();
      loader.load(
        'https://raw.githubusercontent.com/RileyReid1915/3d-models/main/human.glb', 
        (gltf) => {
          model = gltf.scene;

          // Масштабуємо модель для збільшення
          model.scale.set(2, 2, 2); // Збільшуємо розмір вдвічі

          // Центруємо модель
          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          model.position.sub(center);

          scene.add(model);

          const size = box.getSize(new THREE.Vector3());
          camera.position.z = Math.max(size.x, size.y, size.z) * 0.32; // Камера ближче
          camera.lookAt(0, 0, 0);

          animate();
        },
        undefined,
        (error) => {
          console.error('Помилка завантаження моделі:', error);
        }
      );

      function animate() {
        requestAnimationFrame(animate);
        if (model) model.rotation.y += 0.01; // Плавне обертання моделі
        renderer.render(scene, camera);
      }

      // Оновлення shape keys на основі введених даних
      function updateShapeKeys(weight, height, age) {
        const mesh = model.children[0]; // Припущення: перший об'єкт має shape keys
        if (mesh.morphTargetInfluences) {
          mesh.morphTargetInfluences[0] = weight / 100; // Зміна key1
          mesh.morphTargetInfluences[1] = height / 200; // Зміна key2
          mesh.morphTargetInfluences[2] = age / 100; // Зміна key3
        }
      }

      // Обробка форми
      document.getElementById('calorie-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const weight = parseFloat(document.getElementById('weight').value);
        const height = parseFloat(document.getElementById('height').value);
        const age = parseInt(document.getElementById('age').value);
        const gender = document.getElementById('gender').value;

        try {
          const response = await fetch('https://calorie-api-n8u8.onrender.com/api/calculate-calories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weight, height, age, gender })
          });

          if (!response.ok) throw new Error('Помилка при запиті до API');

          const data = await response.json();
          document.getElementById('result').innerText = `Добова норма калорій: ${data.daily_calories} ккал`;

          updateShapeKeys(weight, height, age); // Оновлюємо shape keys моделі
        } catch (error) {
          document.getElementById('result').innerText = 'Сталася помилка: ' + error.message;
        }
      });
    })();
  </script>
</div>
