<div id="calorie-widget" style="width: 100%; max-width: 600px; margin: 20px auto;">
  <h2>Калькулятор Калорій</h2>
  <form id="calorie-form">
    <input type="range" id="weight-slider" min="30" max="200" value="70" />
    <label for="weight-slider">Вага (кг)</label><br />
    
    <input type="range" id="height-slider" min="100" max="220" value="170" />
    <label for="height-slider">Зріст (см)</label><br />
    
    <input type="range" id="age-slider" min="18" max="65" value="30" />
    <label for="age-slider">Вік</label><br />
    
    <select id="gender">
      <option value="male">Чоловік</option>
      <option value="female">Жінка</option>
    </select>
    <button type="submit">Розрахувати</button>
  </form>

  <p id="result"></p>
  <div id="3d-container" style="width: 100%; height: 300px; margin-top: 20px;"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    (function () {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, 600 / 300, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(600, 300);
      document.getElementById('3d-container').appendChild(renderer.domElement);

      let model;

      const light = new THREE.AmbientLight(0xffffff, 1);
      scene.add(light);

      const loader = new THREE.GLTFLoader();
      loader.load(
        'https://raw.githubusercontent.com/RileyReid1915/3d-models/main/human.glb',
        (gltf) => {
          model = gltf.scene;
          scene.add(model);

          const mesh = findMeshWithShapeKeys(model);

          if (mesh) {
            console.log('Знайдено mesh з shape keys:', mesh);
            setupSliders(mesh);
          } else {
            console.warn('Не вдалося знайти mesh із shape keys.');
          }

          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          model.position.sub(center);

          const size = box.getSize(new THREE.Vector3());
          camera.position.z = Math.max(size.x, size.y, size.z) * 2;
          camera.lookAt(0, 0, 0);

          animate();
        },
        undefined,
        (error) => {
          console.error('Помилка завантаження моделі:', error);
        }
      );

      function findMeshWithShapeKeys(object) {
        let targetMesh = null;
        object.traverse((child) => {
          console.log('Перевіряємо об\'єкт:', child.name);
          if (child.morphTargetInfluences) {
            console.log('Знайдено shape keys у:', child.name);
            targetMesh = child;
          }
        });

        return targetMesh;
      }

      function setupSliders(mesh) {
        document.getElementById('weight-slider').addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          mesh.morphTargetInfluences[1] = value / 200;
          console.log('Вага:', value, 'Morph Influence key2:', mesh.morphTargetInfluences[1]);
        });

        document.getElementById('height-slider').addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          mesh.morphTargetInfluences[0] = value / 220;
          console.log('Зріст:', value, 'Morph Influence key1:', mesh.morphTargetInfluences[0]);
        });

        document.getElementById('age-slider').addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          mesh.morphTargetInfluences[2] = value / 65;
          console.log('Вік:', value, 'Morph Influence key3:', mesh.morphTargetInfluences[2]);
        });
      }

      function animate() {
        requestAnimationFrame(animate);
        if (model) model.rotation.y += 0.01;
        renderer.render(scene, camera);
      }

      document.getElementById('calorie-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const weight = parseFloat(document.getElementById('weight-slider').value);
        const height = parseFloat(document.getElementById('height-slider').value);
        const age = parseInt(document.getElementById('age-slider').value);
        const gender = document.getElementById('gender').value;

        try {
          const response = await fetch('https://calorie-api-n8u8.onrender.com/api/calculate-calories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weight, height, age, gender })
          });

          if (!response.ok) throw new Error('Помилка при запиті до API');

          const data = await response.json();
          document.getElementById('result').innerText = `Добова норма калорій: ${data.daily_calories} ккал`;
        } catch (error) {
          document.getElementById('result').innerText = 'Сталася помилка: ' + error.message;
        }
      });
    })();
  </script>
</div>
